<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================== 
     Aug 9, 2011

     Build Components (based on direct scripts)
                        
     lmmortal                                                                
     ====================================================================== -->
<project name="tools.components.tasks">
    <description>
        Defines tasks that execute ant scripts or build targets on all the components.
    </description>

    <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

    <!-- = = = = = = = = = = = = = = = = =
          macrodef: run-targets-all

          Builds a target on each of the components.
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="run-target-all" description="Builds a target on each of the component.">

        <!-- the target to build on every component -->
        <attribute name="target" />

        <!-- properties that will be passed to the target to build -->
        <element name="properties" optional="true"/>

        <sequential>
            <execute-all prefix="project.current">
                <sequential>
                  <echo message=""/>
                  <echo message="--- Executing for: ${project.current.name}"/>
                  <ant antfile="${project.current.basedir}/${project.current.buildfile}" target="@{target}" inheritall="false">
                    <propertyset>
                      <propertyref builtin="commandline"/>
                    </propertyset>
                    <properties />
                  </ant>
                </sequential>
            </execute-all>
        </sequential>
    </macrodef>

    <!-- = = = = = = = = = = = = = = = = =
         scriptdef: execute-all

         Runs any ant-script sequence on all components.
         = = = = = = = = = = = = = = = = = -->
    <scriptdef name="execute-all" language="groovy" description="Runs a sequence of ant script on all the components." classpathref="script.path">

        <!-- the prefix of the exported properties -->
        <attribute name="prefix" />

        <!-- the ant-script to run on each of the projects -->
        <element name="sequential" type="sequential" />

        <![CDATA[
        import groovy.util.XmlParser

        def prefix = attributes.prefix
        def components = new XmlParser().parse(new File(project.getProperty("components.conf")))

        components.component.each { component ->
            [[name : 'name', required : true ],
                    [name : 'svnpath', required : true ],
                    [name : 'basedir', required : false, defaultValue : project.getProperty("components_dir")+'/'+ component.'@name'],
                    [name : 'revision', required : false, defaultValue : 'HEAD']].each {

                        def value = component."@${it.name}"

                        if (value == null || value.trim().length() == 0) {
                            if (it.required) {
                                self.fail("The ${it.name} attribute of a component is required.")
                            }

                            value = it.defaultValue
                        }

                        value = project.replaceProperties(value)
                        project.setProperty("${prefix}.${it.name}", value)
                    }
            elements.sequential.each { it.execute() }
        }
        ]]>
    </scriptdef> 

    <!-- = = = = = = = = = = = = = = = = =
           scriptdef: component-info

           Gets the svn path and revision of a component.

           This task is only used within the 'execute-all' task.
          = = = = = = = = = = = = = = = = = = = = -->
    <scriptdef name="component-info" language="groovy" classpathref="script.path"
        description="Gets the info of a specific component.">

        <!-- prefix of the properties containing the component information -->
        <attribute name="prefix" />

        <!-- the property which holds the svn path of the specific component -->
        <attribute name="property1" />
        
        <!-- the property which holds the svn revision of the specific component -->
        <attribute name="property2" />

        <![CDATA[
        def prefix = attributes.prefix

        project.setProperty("${attributes.property1}", project.getProperty("${prefix}.svnpath"))
        project.setProperty("${attributes.property2}", project.getProperty("${prefix}.revision"))
        ]]>
    </scriptdef>

    <!-- = = = = = = = = = = = = = = = = =
          macrodef: svnex

          This tasks execute svn operations against cached credentials,
          or prompt for password if svn.username property is set.
         = = = = = = = = = = = = = = = = = -->
    <macrodef name="svnex">

        <!-- the operations to be performed via subversion -->
        <element name="operation" implicit="true"/>

        <sequential>
            <if>
                <isset property="svn.username"/>
                <then>
                    <if>
                        <not>
                            <isset property="svn.password"/>
                        </not>
                        <then>
                            <input addproperty="svn.password" message="Please enter svn password: "/>
                        </then>
                    </if>
                    <svn javahl="false" username="${svn.username}" password="${svn.password}">
                        <operation />
                    </svn>
                </then>
                <else>
                    <svn javahl="false">
                        <operation />
                    </svn>
                </else>
            </if>
        </sequential>
    </macrodef>
</project>
