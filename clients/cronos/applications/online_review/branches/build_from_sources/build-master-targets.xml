<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================== 
     Aug 9, 2011

     Build Master (copied from direct scripts)
                        
     lmmortal                                                                
     ====================================================================== -->
<project name="build-master-targets">
  <description>
        This script file defines the common master targets.
  </description>

  <!-- subversion tasks -->
  <typedef resource="org/tigris/subversion/svnant/svnantlib.xml" classpathref="svn.path" />


  <!-- =================================
         target: checkout-components
         ================================= -->
  <target name="checkout-components" description="Checks out all components">
    <execute-all prefix="component.current">
      <sequential>
        <component-info property="url" prefix="component.current" />
        <echo message="-------------------- Checking out: ${component.current.basedir} to revision ${revision}"/>
        <svnex>
          <checkout destPath="${basedir}/${component.current.basedir}" url="${url}" revision="${revision}" />
        </svnex>
      </sequential>
    </execute-all>
  </target>

  <!--
    Added the switch-and-checkout target which switches the root project to the specified branch and then syncs all components.
    @author: snow01
    @since: BUGR-3482
  -->
  <target name="switch-and-checkout" description="Switches the root to the specified branch and then syncs all components">
    <!-- Receives branch url as -DbranchURL=http://... -->
    <if>
      <isset property="branchURL"/>
      <then>
        <svnex>
          <switch path="${basedir}" url="${branchURL}" />
        </svnex>
      </then>
    </if>
    <echo message="DEBUG: -------------------- Starting sync for components"/>
    <antcall target="sync-all" />
  </target>

  <!--
    Checkout / sync all components to the branch defined in components.xml.
    @author: snow01
    @since: BUGR-3482
  -->
    <target name="sync-all" description="Checkout / sync all components to the branch defined in components.xml.">
        <execute-all prefix="project.current">
            <sequential>
                <echo message="DEBUG: -------------------- Checking for: ${project.current.basedir}"/>

                <condition property="version" value="TRUNK">
                    <not>
                        <isset property="version" />
                    </not>
                </condition>
                <version-path version="${version}" property="url" prefix="project.current" />
                <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>
                <!-- check if directory exist -->
                <!-- if yes check the branch name -->
                <!-- if matches simply update -->
                <!-- else switch -->
                <if>
                    <available file="${basedir}/${project.current.basedir}"/>
                    <then>
                        <svnex>
                            <info target="${basedir}/${project.current.basedir}"/>
                        </svnex>
                        <if>
                            <not>
                                <equals arg1="${svn.info.url}" arg2="${url}"/>
                            </not>
                            <then>
                                <echo message="-------------------- Switching to url: ${url}"/>
                                <svnex>
                                    <switch path="${basedir}/${project.current.basedir}" url="${url}" />
                                </svnex>
                            </then>
                            <else>
                                <echo message="-------------------- Updating: ${url}"/>
                                <svnex>
                                    <update dir="${basedir}/${project.current.basedir}" />
                                </svnex>
                            </else>
                        </if>
                    </then>
                    <!-- if not checkout the project -->
                    <else>
                        <echo message="-------------------- Checking out: ${project.current.basedir}"/>
                        <svnex>
                            <checkout destPath="${basedir}/${project.current.basedir}" url="${url}" />
                        </svnex>
                    </else>
                </if>
            </sequential>
        </execute-all>
    </target>

    <target name="sync" description="Checkout / sync a single component to the branch defined in components.xml.">
      <if>
        <isset property="project"/>
            <then>
            <execute-single prefix="project.current" component="${project}">
                <sequential>
                    <echo message="DEBUG: -------------------- Checking for: ${project.current.basedir}"/>

                    <condition property="version" value="TRUNK">
                        <not>
                            <isset property="version" />
                        </not>
                    </condition>
                    <version-path version="${version}" property="url" prefix="project.current" />
                    <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>
                    <!-- check if directory exist -->
                    <!-- if yes check the branch name -->
                    <!-- if matches simply update -->
                    <!-- else switch -->
                    <if>
                        <available file="${basedir}/${project.current.basedir}"/>
                        <then>
                            <svnex>
                                <info target="${basedir}/${project.current.basedir}"/>
                            </svnex>
                            <if>
                                <not>
                                    <equals arg1="${svn.info.url}" arg2="${url}"/>
                                </not>
                                <then>
                                    <echo message="-------------------- Switching to url: ${url}"/>
                                    <svnex>
                                        <switch path="${basedir}/${project.current.basedir}" url="${url}" />
                                    </svnex>
                                </then>
                                <else>
                                    <echo message="-------------------- Updating: ${url}"/>
                                    <svnex>
                                        <update dir="${basedir}/${project.current.basedir}" />
                                    </svnex>
                                </else>
                            </if>
                        </then>
                        <!-- if not, checkout the project -->
                        <else>
                            <echo message="-------------------- Checking out: ${project.current.basedir}"/>
                            <svnex>
                                <checkout destPath="${basedir}/${project.current.basedir}" url="${url}" />
                            </svnex>
                        </else>
                    </if>
                </sequential>
            </execute-single>
            </then>
            <else>
                <echo message="Please specify the project name to sync like -Dproject=configuration_manager in commandline."/>
            </else>
        </if>
    </target>
</project>
